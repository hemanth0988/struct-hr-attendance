<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Struct HR – Add Employee</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 0 10px;
    }
    h1 {
      margin-bottom: 10px;
    }
    .panel {
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
    }
    label {
      display: inline-block;
      width: 200px;
      margin-bottom: 6px;
    }
    input[type="text"],
    input[type="date"] {
      padding: 4px 6px;
      width: 200px;
    }
    input[readonly] {
      background: #f7f7f7;
    }
    button {
      padding: 6px 12px;
      margin-top: 10px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
    }
    th {
      background: #f3f3f3;
    }
    #status {
      margin-left: 10px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <h1>Struct HR – Add Employee</h1>

  <div class="panel">
    <h3>Step 1 – New Employee Details</h3>

    <div>
      <label for="nameInput">Name *</label>
      <input type="text" id="nameInput" />
    </div>

    <div>
      <label for="joiningDateInput">Joining date *</label>
      <input type="date" id="joiningDateInput" />
    </div>

    <h4>Monthly salary components *</h4>

    <div>
      <label for="basicMonthlyInput">Basic pay (monthly)</label>
      <input type="text" id="basicMonthlyInput" />
    </div>
    <div>
      <label for="transportMonthlyInput">Transport (monthly)</label>
      <input type="text" id="transportMonthlyInput" />
    </div>
    <div>
      <label for="accommodationMonthlyInput">Accommodation (monthly)</label>
      <input type="text" id="accommodationMonthlyInput" />
    </div>
    <div>
      <label for="otherMonthlyInput">Other (monthly)</label>
      <input type="text" id="otherMonthlyInput" />
    </div>

    <div>
      <label for="totalMonthlyInput">Total salary (monthly)</label>
      <input type="text" id="totalMonthlyInput" readonly />
    </div>

    <h4>Leave-related daily amounts *</h4>

    <div>
      <label for="paidLeaveDailyInput">Paid leave (daily)</label>
      <input type="text" id="paidLeaveDailyInput" />
    </div>
    <div>
      <label for="vacationDailyInput">Vacation pay (daily)</label>
      <input type="text" id="vacationDailyInput" />
    </div>

    <button id="addBtn">Add Employee</button>
    <span id="status"></span>
  </div>

  <div class="panel">
    <h3>Step 2 – Current Employees (read-only)</h3>
    <button id="refreshBtn">Refresh List</button>
    <table id="employeesTable">
      <thead>
        <tr>
          <th>Emp Code</th>
          <th>Name</th>
          <th>Joining Date</th>
          <th>Current Status</th>
        </tr>
      </thead>
      <tbody>
        <!-- rows injected here -->
      </tbody>
    </table>
  </div>

  <script>
    const API_BASE = "https://struct-hr-attendance-production.up.railway.app";

    const nameInput = document.getElementById("nameInput");
    const joiningDateInput = document.getElementById("joiningDateInput");

    const basicMonthlyInput = document.getElementById("basicMonthlyInput");
    const transportMonthlyInput = document.getElementById("transportMonthlyInput");
    const accommodationMonthlyInput = document.getElementById("accommodationMonthlyInput");
    const otherMonthlyInput = document.getElementById("otherMonthlyInput");
    const totalMonthlyInput = document.getElementById("totalMonthlyInput");

    const paidLeaveDailyInput = document.getElementById("paidLeaveDailyInput");
    const vacationDailyInput = document.getElementById("vacationDailyInput");

    const addBtn = document.getElementById("addBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const statusSpan = document.getElementById("status");
    const employeesTableBody = document.querySelector("#employeesTable tbody");

    function setStatus(msg, isError = false) {
      statusSpan.textContent = msg || "";
      statusSpan.style.color = isError ? "red" : "green";
    }

    // -------- Decimal helpers (for text inputs) --------

    // Only digits + one dot, max 2 decimals
    function cleanMoneyInput(input) {
      let v = input.value;

      // remove everything except digits and .
      v = v.replace(/[^\d.]/g, "");

      const firstDot = v.indexOf(".");
      if (firstDot !== -1) {
        const before = v.slice(0, firstDot + 1); // include the dot
        let after = v.slice(firstDot + 1);

        // remove any extra dots in the decimal part
        after = after.replace(/\./g, "");

        // cap decimals at 2 digits
        if (after.length > 2) {
          after = after.slice(0, 2);
        }

        v = before + after;
      }

      input.value = v;
    }

    // On blur, normalise to exactly 2 decimals (if value is valid)
    function normaliseTwoDecimals(input) {
      if (input.value === "") return;
      const n = parseFloat(input.value);
      if (isNaN(n)) {
        input.value = "";
      } else {
        input.value = n.toFixed(2);
      }
    }

    const moneyInputs = [
      basicMonthlyInput,
      transportMonthlyInput,
      accommodationMonthlyInput,
      otherMonthlyInput,
      paidLeaveDailyInput,
      vacationDailyInput
    ];

    moneyInputs.forEach(inp => {
      inp.value = ""; // ensure empty by default

      inp.addEventListener("input", () => {
        const oldCursor = inp.selectionStart;
        cleanMoneyInput(inp);
        // try to keep cursor roughly where it was
        inp.selectionStart = inp.selectionEnd = oldCursor;

        if (
          inp === basicMonthlyInput ||
          inp === transportMonthlyInput ||
          inp === accommodationMonthlyInput ||
          inp === otherMonthlyInput
        ) {
          recalcTotals();
        }
      });

      inp.addEventListener("blur", () => {
        normaliseTwoDecimals(inp);
        if (
          inp === basicMonthlyInput ||
          inp === transportMonthlyInput ||
          inp === accommodationMonthlyInput ||
          inp === otherMonthlyInput
        ) {
          recalcTotals();
        }
      });
    });

    function valueOrZero(inp) {
      const n = parseFloat(inp.value);
      return isNaN(n) ? 0 : n;
    }

    function recalcTotals() {
      const bm = valueOrZero(basicMonthlyInput);
      const tm = valueOrZero(transportMonthlyInput);
      const am = valueOrZero(accommodationMonthlyInput);
      const om = valueOrZero(otherMonthlyInput);

      const total = bm + tm + am + om;

      if (total > 0) {
        totalMonthlyInput.value = total.toFixed(2);
        const daily = (total / 30).toFixed(2);
        paidLeaveDailyInput.value = daily;
        vacationDailyInput.value = daily;
      } else {
        totalMonthlyInput.value = "";
        paidLeaveDailyInput.value = "";
        vacationDailyInput.value = "";
      }
    }

    // -------- Add Employee --------

    addBtn.addEventListener("click", async () => {
      setStatus("");

      const name = nameInput.value.trim();
      const joiningDate = joiningDateInput.value;

      if (!name || !joiningDate) {
        setStatus("Name and Joining date are required.", true);
        return;
      }

      if (
        basicMonthlyInput.value === "" ||
        transportMonthlyInput.value === "" ||
        accommodationMonthlyInput.value === "" ||
        otherMonthlyInput.value === ""
      ) {
        setStatus("All monthly salary components are required.", true);
        return;
      }

      if (paidLeaveDailyInput.value === "" || vacationDailyInput.value === "") {
        setStatus("Paid leave daily and Vacation daily are required.", true);
        return;
      }

      const basicMonthly = valueOrZero(basicMonthlyInput);
      const transportMonthly = valueOrZero(transportMonthlyInput);
      const accommodationMonthly = valueOrZero(accommodationMonthlyInput);
      const otherMonthly = valueOrZero(otherMonthlyInput);

      const paidLeaveDaily = valueOrZero(paidLeaveDailyInput);
      const vacationDaily = valueOrZero(vacationDailyInput);

      const payload = {
        name: name,
        joining_date: joiningDate,
        basic_pay_monthly: basicMonthly,
        transport_monthly: transportMonthly,
        accommodation_monthly: accommodationMonthly,
        other_monthly: otherMonthly,
        paid_leave_daily: paidLeaveDaily,
        vacation_pay_daily: vacationDaily
      };

      try {
        setStatus("Saving...");
        const res = await fetch(`${API_BASE}/employees/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || "Failed to create employee");
        }
        const emp = await res.json();

        setStatus(`Employee ${emp.emp_code} created successfully.`);

        // Clear form
        nameInput.value = "";
        joiningDateInput.value = "";
        basicMonthlyInput.value = "";
        transportMonthlyInput.value = "";
        accommodationMonthlyInput.value = "";
        otherMonthlyInput.value = "";
        totalMonthlyInput.value = "";
        paidLeaveDailyInput.value = "";
        vacationDailyInput.value = "";

        await loadEmployees();
      } catch (e) {
        console.error(e);
        setStatus(e.message, true);
      }
    });

    // -------- List Employees (bottom table) --------

    async function loadEmployees() {
      try {
        const res = await fetch(`${API_BASE}/employees/`);
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || "Failed to fetch employees");
        }
        const data = await res.json();

        employeesTableBody.innerHTML = "";
        data.forEach(emp => {
          const tr = document.createElement("tr");
          const tdCode = document.createElement("td");
          tdCode.textContent = emp.emp_code;
          const tdName = document.createElement("td");
          tdName.textContent = emp.name;
          const tdJoin = document.createElement("td");
          tdJoin.textContent = emp.joining_date;
          const tdStatus = document.createElement("td");
          tdStatus.textContent = emp.current_status;
          tr.appendChild(tdCode);
          tr.appendChild(tdName);
          tr.appendChild(tdJoin);
          tr.appendChild(tdStatus);
          employeesTableBody.appendChild(tr);
        });
      } catch (e) {
        console.error(e);
        setStatus(e.message, true);
      }
    }

    refreshBtn.addEventListener("click", loadEmployees);

    // Initial load
    loadEmployees();
  </script>
</body>
</html>
