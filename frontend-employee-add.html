<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Employees</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1100px;
      margin: 20px auto;
      padding: 0 10px;
    }
    .panel {
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      background: #fafafa;
    }
    button {
      padding: 6px 12px;
      cursor: pointer;
      margin-right: 8px;
      margin-top: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
    }
    th {
      background: #f3f3f3;
    }
    #statusMsg {
      font-size: 0.9rem;
      margin-left: 8px;
    }
    #todayWarning {
      color: red;
      margin-bottom: 10px;
      font-size: 0.9rem;
      display: none;
    }
    select, input[type="date"] {
      font-size: 13px;
      padding: 3px 4px;
    }

    /* Overlay styles */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .overlay.visible {
      display: flex;
    }
    .overlay-content {
      background: #fff;
      padding: 16px 20px;
      border-radius: 8px;
      width: 550px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
    }
    .overlay-content h3 {
      margin-top: 0;
      margin-bottom: 10px;
    }
    .overlay-content label {
      display: inline-block;
      width: 200px;
      margin-bottom: 6px;
    }
    .overlay-content input[type="text"],
    .overlay-content input[type="date"] {
      padding: 4px 6px;
      width: 200px;
    }
    .overlay-actions {
      margin-top: 10px;
    }
    #addStatus,
    #updateStatusMsg {
      margin-left: 8px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>

  <div id="todayWarning">
    Please set <strong>Today</strong> at the top before viewing or changing employees.
  </div>

  <div class="panel">
    <h3>Employee List & Status</h3>

    <div>
      <button id="reloadBtn">Refresh list</button>
      <button id="resetDbBtn">Reset DB</button>
      <button id="openAddOverlayBtn">Add new employee</button>
      <span id="statusMsg"></span>
    </div>

    <table id="statusTable">
      <thead>
        <tr>
          <th>Emp Code</th>
          <th>Name</th>
          <th>Joining Date</th>
          <th>Current Status</th>
          <th>New Status</th>
          <th>Effective Date</th>
          <th>Update Status</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>

  <!-- Add Employee Overlay -->
  <div id="addEmployeeOverlay" class="overlay">
    <div class="overlay-content">
      <h3>Add new employee</h3>

      <div>
        <label for="nameInput">Name *</label>
        <input type="text" id="nameInput" />
      </div>

      <div>
        <label for="joiningDateInput">Joining date *</label>
        <input type="date" id="joiningDateInput" />
      </div>

      <h4>Monthly salary components *</h4>
      <div><label>Basic pay (monthly)</label><input type="text" id="basicMonthlyInput" /></div>
      <div><label>Transport (monthly)</label><input type="text" id="transportMonthlyInput" /></div>
      <div><label>Accommodation (monthly)</label><input type="text" id="accommodationMonthlyInput" /></div>
      <div><label>Other (monthly)</label><input type="text" id="otherMonthlyInput" /></div>

      <div><label>Total salary (monthly)</label><input type="text" id="totalMonthlyInput" readonly /></div>

      <h4>Leave-related daily amounts *</h4>
      <div><label>Paid leave (daily)</label><input type="text" id="paidLeaveDailyInput" /></div>
      <div><label>Vacation pay (daily)</label><input type="text" id="vacationDailyInput" /></div>

      <div class="overlay-actions">
        <button id="addEmployeeBtn">Add employee</button>
        <button id="cancelAddBtn">Cancel</button>
        <span id="addStatus"></span>
      </div>
    </div>
  </div>

  <!-- Update Status Overlay -->
  <div id="updateStatusOverlay" class="overlay">
    <div class="overlay-content">
      <h3>Update status – <span id="updateEmpLabel"></span></h3>

      <div>
        <label>New Status *</label>
        <select id="updateStatusSelect">
          <option value="">-</option>
          <option value="Active">Active</option>
          <option value="On Vacation">On Vacation</option>
          <option value="Offboarded">Offboarded</option>
        </select>
      </div>

      <div>
        <label>Effective Date *</label>
        <input type="date" id="updateEffectiveDateInput" />
      </div>

      <div class="overlay-actions">
        <button id="saveStatusBtn">Submit</button>
        <button id="cancelStatusBtn">Cancel</button>
        <span id="updateStatusMsg"></span>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://struct-hr-attendance-production.up.railway.app";
    const TODAY_KEY = "struct_hr_manual_today_global";

    const reloadBtn = document.getElementById("reloadBtn");
    const resetDbBtn = document.getElementById("resetDbBtn");
    const openAddOverlayBtn = document.getElementById("openAddOverlayBtn");

    const statusMsg = document.getElementById("statusMsg");
    const statusTableBody = document.querySelector("#statusTable tbody");
    const todayWarning = document.getElementById("todayWarning");

    /* ---------- Add Employee Elements ---------- */
    const addOverlay = document.getElementById("addEmployeeOverlay");
    const addEmployeeBtn = document.getElementById("addEmployeeBtn");
    const cancelAddBtn = document.getElementById("cancelAddBtn");
    const addStatusSpan = document.getElementById("addStatus");
    const nameInput = document.getElementById("nameInput");
    const joiningDateInput = document.getElementById("joiningDateInput");
    const basicMonthlyInput = document.getElementById("basicMonthlyInput");
    const transportMonthlyInput = document.getElementById("transportMonthlyInput");
    const accommodationMonthlyInput = document.getElementById("accommodationMonthlyInput");
    const otherMonthlyInput = document.getElementById("otherMonthlyInput");
    const totalMonthlyInput = document.getElementById("totalMonthlyInput");
    const paidLeaveDailyInput = document.getElementById("paidLeaveDailyInput");
    const vacationDailyInput = document.getElementById("vacationDailyInput");

    /* ---------- Update Status Overlay Elements ---------- */
    const updateOverlay = document.getElementById("updateStatusOverlay");
    const updateEmpLabel = document.getElementById("updateEmpLabel");
    const updateStatusSelect = document.getElementById("updateStatusSelect");
    const updateEffectiveDateInput = document.getElementById("updateEffectiveDateInput");
    const updateStatusMsg = document.getElementById("updateStatusMsg");
    const saveStatusBtn = document.getElementById("saveStatusBtn");
    const cancelStatusBtn = document.getElementById("cancelStatusBtn");

    let currentUpdateEmpCode = null;

    function setMsg(msg, isError = false) {
      statusMsg.textContent = msg;
      statusMsg.style.color = isError ? "red" : "green";
    }

    function updateTodayRequirement() {
      const today = localStorage.getItem(TODAY_KEY);
      if (!today) {
        todayWarning.style.display = "block";
        reloadBtn.disabled = true;
        resetDbBtn.disabled = false;
        openAddOverlayBtn.disabled = true;
        statusTableBody.innerHTML = "";
        setMsg("Set Today at the top to work with employees.", true);
        return false;
      }

      todayWarning.style.display = "none";
      reloadBtn.disabled = false;
      openAddOverlayBtn.disabled = false;
      setMsg("");
      return true;
    }

    /* ------------------ Load Employees ------------------ */

    async function loadStatuses() {
      if (!updateTodayRequirement()) return;

      const today = localStorage.getItem(TODAY_KEY);
      try {
        setMsg("Loading...");
        const res = await fetch(`${API_BASE}/employees/?today=${today}`);
        if (!res.ok) throw new Error("Failed to load employees");

        const data = await res.json();
        statusTableBody.innerHTML = "";

        data.forEach(emp => {
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${emp.emp_code}</td>
            <td>${emp.name}</td>
            <td>${emp.joining_date}</td>
            <td>${emp.current_status}</td>
            <td>${emp.upcoming_status || "-"}</td>
            <td>${emp.status_change_date || "-"}</td>
            <td><button class="updateStatusBtn">Update Status</button></td>
          `;

          tr.querySelector(".updateStatusBtn").addEventListener("click", () => {
            openUpdateOverlay(emp);
          });

          statusTableBody.appendChild(tr);
        });

        setMsg(`Loaded ${data.length} employees for Today = ${today}.`);
      } catch (e) {
        console.error(e);
        setMsg(e.message, true);
      }
    }

    reloadBtn.addEventListener("click", loadStatuses);

    /* ------------------ Reset DB ------------------ */

    resetDbBtn.addEventListener("click", async () => {
      if (!confirm("Are you sure you want to reset all data?")) return;

      try {
        setMsg("Resetting...");
        const res = await fetch(`${API_BASE}/admin/reset`, {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });

        if (!res.ok) throw new Error("Reset failed");

        setMsg("Database reset.");
        localStorage.removeItem(TODAY_KEY);
        window.top.location.reload();
      } catch (e) {
        console.error(e);
        setMsg(e.message, true);
      }
    });

    /* ------------------ Add Employee Overlay ------------------ */

    function openAddOverlay() {
      addStatusSpan.textContent = "";
      nameInput.value = "";
      joiningDateInput.value = "";
      basicMonthlyInput.value = "";
      transportMonthlyInput.value = "";
      accommodationMonthlyInput.value = "";
      otherMonthlyInput.value = "";
      totalMonthlyInput.value = "";
      paidLeaveDailyInput.value = "";
      vacationDailyInput.value = "";
      addOverlay.classList.add("visible");
    }

    function closeAddOverlay() {
      addOverlay.classList.remove("visible");
    }

    openAddOverlayBtn.addEventListener("click", openAddOverlay);
    cancelAddBtn.addEventListener("click", closeAddOverlay);

    /* Money input cleaning + totals */
    function cleanMoneyInput(inp) {
      let v = inp.value.replace(/[^\d.]/g, "");
      const dot = v.indexOf(".");
      if (dot !== -1) {
        v = v.substring(0, dot + 1) + v.substring(dot + 1).replace(/\./g, "").slice(0, 2);
      }
      inp.value = v;
    }

    function norm(inp) {
      if (!inp.value) return;
      const n = parseFloat(inp.value);
      inp.value = isNaN(n) ? "" : n.toFixed(2);
    }

    [basicMonthlyInput, transportMonthlyInput, accommodationMonthlyInput, otherMonthlyInput,
     paidLeaveDailyInput, vacationDailyInput].forEach(inp => {
      inp.addEventListener("input", () => {
        const pos = inp.selectionStart;
        cleanMoneyInput(inp);
        inp.selectionStart = inp.selectionEnd = pos;
        recalcTotals();
      });
      inp.addEventListener("blur", () => {
        norm(inp);
        recalcTotals();
      });
    });

    function recalcTotals() {
      const bm = parseFloat(basicMonthlyInput.value) || 0;
      const tm = parseFloat(transportMonthlyInput.value) || 0;
      const am = parseFloat(accommodationMonthlyInput.value) || 0;
      const om = parseFloat(otherMonthlyInput.value) || 0;
      const total = bm + tm + am + om;

      if (total > 0) {
        totalMonthlyInput.value = total.toFixed(2);
        const daily = (total / 30).toFixed(2);
        paidLeaveDailyInput.value = daily;
        vacationDailyInput.value = daily;
      }
    }

    addEmployeeBtn.addEventListener("click", async () => {
      const today = localStorage.getItem(TODAY_KEY);
      if (!today) {
        addStatusSpan.textContent = "Please set Today first.";
        addStatusSpan.style.color = "red";
        return;
      }

      try {
        addStatusSpan.textContent = "Saving...";

        const payload = {
          name: nameInput.value.trim(),
          joining_date: joiningDateInput.value,
          basic_pay_monthly: parseFloat(basicMonthlyInput.value) || 0,
          transport_monthly: parseFloat(transportMonthlyInput.value) || 0,
          accommodation_monthly: parseFloat(accommodationMonthlyInput.value) || 0,
          other_monthly: parseFloat(otherMonthlyInput.value) || 0,
          paid_leave_daily: parseFloat(paidLeaveDailyInput.value) || 0,
          vacation_pay_daily: parseFloat(vacationDailyInput.value) || 0
        };

        const res = await fetch(`${API_BASE}/employees/?today=${today}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("Failed to add employee");

        addStatusSpan.style.color = "green";
        addStatusSpan.textContent = "Employee saved.";

        await loadStatuses();
        setTimeout(closeAddOverlay, 500);
      } catch (e) {
        console.error(e);
        addStatusSpan.style.color = "red";
        addStatusSpan.textContent = e.message;
      }
    });

    /* ------------------ Update Status Overlay ------------------ */

    function openUpdateOverlay(emp) {
      currentUpdateEmpCode = emp.emp_code;
      updateEmpLabel.textContent = `${emp.emp_code} – ${emp.name}`;
      updateStatusSelect.value = emp.upcoming_status || "";
      updateEffectiveDateInput.value = emp.status_change_date || "";
      updateStatusMsg.textContent = "";
      updateOverlay.classList.add("visible");
    }

    function closeUpdateOverlay() {
      updateOverlay.classList.remove("visible");
    }

    cancelStatusBtn.addEventListener("click", closeUpdateOverlay);

    saveStatusBtn.addEventListener("click", async () => {
      const today = localStorage.getItem(TODAY_KEY);
      if (!today) {
        updateStatusMsg.textContent = "Please set Today first.";
        updateStatusMsg.style.color = "red";
        return;
      }

      const newStatus = updateStatusSelect.value;
      const eff = updateEffectiveDateInput.value;

      if (!newStatus || !eff) {
        updateStatusMsg.textContent = "Both fields required.";
        updateStatusMsg.style.color = "red";
        return;
      }

      if (eff < today) {
        updateStatusMsg.textContent = `Effective Date cannot be earlier than Today (${today}).`;
        updateStatusMsg.style.color = "red";
        return;
      }

      const body = {
        today,
        changes: [
          {
            emp_code: currentUpdateEmpCode,
            new_status: newStatus,
            effective_date: eff
          }
        ]
      };

      try {
        updateStatusMsg.textContent = "Saving...";
        const res = await fetch(`${API_BASE}/employees/status-changes`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!res.ok) throw new Error("Failed to save");

        await loadStatuses();
        setTimeout(closeUpdateOverlay, 500);
      } catch (e) {
        console.error(e);
        updateStatusMsg.textContent = e.message;
        updateStatusMsg.style.color = "red";
      }
    });

    /* ------------------ Init ------------------ */

    document.addEventListener("DOMContentLoaded", () => {
      if (updateTodayRequirement()) loadStatuses();
    });

    window.addEventListener("storage", updateTodayRequirement);
  </script>

</body>
</html>
