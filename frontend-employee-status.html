<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Struct HR – Employee Status</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1100px;
      margin: 20px auto;
      padding: 0 10px;
    }
    h1 {
      margin-bottom: 10px;
    }
    .panel {
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      background: #fafafa;
    }
    button {
      padding: 6px 12px;
      cursor: pointer;
      margin-right: 8px;
      margin-top: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
    }
    th {
      background: #f3f3f3;
    }
    #statusMsg {
      font-size: 0.9rem;
      margin-left: 8px;
    }
    #todayWarning {
      color: red;
      margin-bottom: 10px;
      font-size: 0.9rem;
      display: none;
    }
    select, input[type="date"] {
      font-size: 13px;
      padding: 3px 4px;
    }
  </style>
</head>
<body>
  <h1>Struct HR – Employee Status</h1>

  <div id="todayWarning">
    Please set <strong>Today</strong> at the top before viewing or changing employee status.
  </div>

  <div class="panel">
    <h3>Current & New Status</h3>
    <div>
      <button id="reloadBtn">Reload Status</button>
      <button id="saveChangesBtn">Save New Status Changes</button>
      <span id="statusMsg"></span>
    </div>

    <table id="statusTable">
      <thead>
        <tr>
          <th>Emp Code</th>
          <th>Name</th>
          <th>Joining Date</th>
          <th>Current Status</th>
          <th>New Status</th>
          <th>Effective Date</th>
        </tr>
      </thead>
      <tbody>
        <!-- rows injected here -->
      </tbody>
    </table>
  </div>

  <script>
    const API_BASE = "https://struct-hr-attendance-production.up.railway.app";
    const TODAY_KEY = "struct_hr_manual_today_global";

    const reloadBtn = document.getElementById("reloadBtn");
    const saveChangesBtn = document.getElementById("saveChangesBtn");
    const statusMsg = document.getElementById("statusMsg");
    const statusTableBody = document.querySelector("#statusTable tbody");
    const todayWarning = document.getElementById("todayWarning");

    function setMsg(msg, isError = false) {
      statusMsg.textContent = msg || "";
      statusMsg.style.color = isError ? "red" : "green";
    }

    function getManualToday() {
      return localStorage.getItem(TODAY_KEY) || "";
    }

    function updateTodayRequirement() {
      const today = getManualToday();
      if (!today) {
        todayWarning.style.display = "block";
        reloadBtn.disabled = true;
        saveChangesBtn.disabled = true;
        statusTableBody.innerHTML = "";
        setMsg("Set Today at the top to load and change employee statuses.", true);
        return false;
      } else {
        todayWarning.style.display = "none";
        reloadBtn.disabled = false;
        saveChangesBtn.disabled = false;
        setMsg("");
        return true;
      }
    }

    async function loadStatuses() {
      setMsg("");

      if (!updateTodayRequirement()) {
        return;
      }

      const today = getManualToday();

      try {
        setMsg("Loading...");
        const res = await fetch(`${API_BASE}/employees/?today=${encodeURIComponent(today)}`);
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || "Failed to fetch employees");
        }
        const data = await res.json();

        statusTableBody.innerHTML = "";

        if (!Array.isArray(data) || data.length === 0) {
          setMsg("No employees found.", true);
          return;
        }

        data.forEach(emp => {
          const tr = document.createElement("tr");
          tr.dataset.empCode = emp.emp_code;

          const tdCode = document.createElement("td");
          tdCode.textContent = emp.emp_code;

          const tdName = document.createElement("td");
          tdName.textContent = emp.name;

          const tdJoin = document.createElement("td");
          tdJoin.textContent = emp.joining_date;

          const tdCurrent = document.createElement("td");
          tdCurrent.textContent = emp.current_status;

          const tdNew = document.createElement("td");
          const select = document.createElement("select");
          const opts = ["-", "Active", "On Vacation", "Offboarded"];
          opts.forEach(label => {
            const opt = document.createElement("option");
            opt.textContent = label;
            opt.value = label === "-" ? "" : label;
            select.appendChild(opt);
          });

          // Pre-fill upcoming status if present
          const upcoming = emp.upcoming_status || "";
          if (upcoming) {
            select.value = upcoming;
          }

          tdNew.appendChild(select);

          const tdDate = document.createElement("td");
          const dateInput = document.createElement("input");
          dateInput.type = "date";

          // Pre-fill effective date if present
          const effDate = emp.status_change_date || "";
          if (effDate) {
            // Assuming backend sends YYYY-MM-DD
            dateInput.value = effDate;
          }

          tdDate.appendChild(dateInput);

          tr.appendChild(tdCode);
          tr.appendChild(tdName);
          tr.appendChild(tdJoin);
          tr.appendChild(tdCurrent);
          tr.appendChild(tdNew);
          tr.appendChild(tdDate);
          statusTableBody.appendChild(tr);
        });

        setMsg(`Loaded ${data.length} employees for Today = ${today}.`);
      } catch (e) {
        console.error(e);
        setMsg(e.message, true);
      }
    }

    reloadBtn.addEventListener("click", loadStatuses);

    // Save New Status changes – uses backend /employees/status-changes
    saveChangesBtn.addEventListener("click", async () => {
      setMsg("");

      if (!updateTodayRequirement()) {
        return;
      }
      const today = getManualToday();

      const rows = Array.from(statusTableBody.querySelectorAll("tr"));
      if (rows.length === 0) {
        setMsg("No employees loaded. Reload status first.", true);
        return;
      }

      const changes = [];
      for (const tr of rows) {
        const empCode = tr.dataset.empCode;
        const select = tr.querySelector("select");
        const dateInput = tr.querySelector('input[type="date"]');

        const newStatus = select.value;
        const effectiveDate = dateInput.value;

        if (!newStatus && !effectiveDate) {
          continue;
        }

        // If one is set but not the other -> error
        if ((newStatus && !effectiveDate) || (!newStatus && effectiveDate)) {
          setMsg(
            `Employee ${empCode}: both New Status and Effective Date are required if you set either.`,
            true
          );
          return;
        }

        // Effective date must be >= Today (your 3rd requirement)
        if (effectiveDate < today) {
          setMsg(
            `Employee ${empCode}: Effective Date cannot be earlier than Today (${today}).`,
            true
          );
          return;
        }

        changes.push({
          emp_code: empCode,
          new_status: newStatus,
          effective_date: effectiveDate
        });
      }

      if (changes.length === 0) {
        setMsg("No changes to save.", true);
        return;
      }

      try {
        setMsg("Saving changes...");
        const res = await fetch(`${API_BASE}/employees/status-changes`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ today, changes })
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || "Failed to save status changes");
        }
        const result = await res.json();
        setMsg(`Saved ${result.updated} status change(s).`);
        await loadStatuses();
      } catch (e) {
        console.error(e);
        setMsg(e.message, true);
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      if (updateTodayRequirement()) {
        loadStatuses();
      }
    });

    window.addEventListener("storage", () => {
      updateTodayRequirement();
    });
  </script>
</body>
</html>
