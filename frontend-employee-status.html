<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Struct HR – Employee Status</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 0 10px;
    }
    h1 {
      margin-bottom: 10px;
    }
    .panel {
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      background: #fafafa;
    }
    button {
      padding: 6px 12px;
      cursor: pointer;
      margin-right: 8px;
      margin-top: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
    }
    th {
      background: #f3f3f3;
    }
    #statusMsg {
      font-size: 0.9rem;
      margin-left: 8px;
    }
    #todayWarning {
      color: red;
      margin-bottom: 10px;
      font-size: 0.9rem;
      display: none;
    }
  </style>
</head>
<body>
  <h1>Struct HR – Employee Status</h1>

  <div id="todayWarning">
    Please set <strong>Today</strong> at the top before viewing employee status.
  </div>

  <div class="panel">
    <h3>Current Employee Status (read-only)</h3>
    <div>
      <button id="reloadBtn">Reload Status</button>
      <span id="statusMsg"></span>
    </div>

    <table id="statusTable">
      <thead>
        <tr>
          <th>Emp Code</th>
          <th>Name</th>
          <th>Joining Date</th>
          <th>Current Status</th>
        </tr>
      </thead>
      <tbody>
        <!-- rows injected here -->
      </tbody>
    </table>
  </div>

  <script>
    const API_BASE = "https://struct-hr-attendance-production.up.railway.app";
    const TODAY_KEY = "struct_hr_manual_today_global";

    const reloadBtn = document.getElementById("reloadBtn");
    const statusMsg = document.getElementById("statusMsg");
    const statusTableBody = document.querySelector("#statusTable tbody");
    const todayWarning = document.getElementById("todayWarning");

    function setMsg(msg, isError = false) {
      statusMsg.textContent = msg || "";
      statusMsg.style.color = isError ? "red" : "green";
    }

    function getManualToday() {
      return localStorage.getItem(TODAY_KEY) || "";
    }

    function updateTodayRequirement() {
      const today = getManualToday();
      if (!today) {
        todayWarning.style.display = "block";
        reloadBtn.disabled = true;
        statusTableBody.innerHTML = "";
        setMsg("Set Today at the top to load employee statuses.", true);
        return false;
      } else {
        todayWarning.style.display = "none";
        reloadBtn.disabled = false;
        setMsg("");
        return true;
      }
    }

    async function loadStatuses() {
      setMsg("");

      if (!updateTodayRequirement()) {
        return;
      }

      const today = getManualToday();

      try {
        setMsg("Loading...");
        // Pass Today as a query parameter – backend can start using this later
        const res = await fetch(`${API_BASE}/employees/?today=${encodeURIComponent(today)}`);
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || "Failed to fetch employees");
        }
        const data = await res.json();

        statusTableBody.innerHTML = "";

        if (!Array.isArray(data) || data.length === 0) {
          setMsg("No employees found.", true);
          return;
        }

        data.forEach(emp => {
          const tr = document.createElement("tr");

          const tdCode = document.createElement("td");
          tdCode.textContent = emp.emp_code;

          const tdName = document.createElement("td");
          tdName.textContent = emp.name;

          const tdJoin = document.createElement("td");
          tdJoin.textContent = emp.joining_date;

          const tdStatus = document.createElement("td");
          tdStatus.textContent = emp.current_status;

          tr.appendChild(tdCode);
          tr.appendChild(tdName);
          tr.appendChild(tdJoin);
          tr.appendChild(tdStatus);
          statusTableBody.appendChild(tr);
        });

        setMsg(`Loaded ${data.length} employees for Today = ${today}.`);
      } catch (e) {
        console.error(e);
        setMsg(e.message, true);
      }
    }

    // Button click
    reloadBtn.addEventListener("click", loadStatuses);

    // On page load
    document.addEventListener("DOMContentLoaded", () => {
      // Check Today and auto-load if set
      if (updateTodayRequirement()) {
        loadStatuses();
      }
    });

    // If Today changes while this page is open (user changes top bar then comes back)
    window.addEventListener("storage", () => {
      updateTodayRequirement();
    });
  </script>
</body>
</html>
